<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test d'arborescence - Sonification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .modal-content p {
            margin-bottom: 20px;
            line-height: 1.6;
            color: #555;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-buttons button {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .modal-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-1 { background: #4CAF50; color: white; }
        .btn-2 { background: #2196F3; color: white; }
        .btn-3 { background: #FF9800; color: white; }
        .btn-4 { background: #E91E63; color: white; }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .info-item label {
            font-size: 12px;
            color: #666;
            display: block;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .target-function {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .start-btn {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .start-btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .tree-container {
            padding: 30px;
            max-height: 500px;
            overflow-y: auto;
        }

        .tree-node {
            margin-left: 20px;
        }

        .tree-item {
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .tree-item:hover {
            background: #f0f0f0;
        }

        .tree-item.parent {
            background: #e3f2fd;
            font-weight: bold;
        }

        .tree-item.parent:hover {
            background: #bbdefb;
        }

        .tree-item.leaf {
            background: #fff;
            border: 2px solid #e0e0e0;
        }

        .tree-item.leaf:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .tree-item.correct {
            background: #4CAF50 !important;
            color: white;
            animation: pulse 0.5s;
        }

        .tree-item.wrong {
            background: #f44336 !important;
            color: white;
            animation: shake 0.5s;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .toggle-icon {
            display: inline-block;
            margin-right: 10px;
            font-weight: bold;
        }

        .results-modal .modal-content {
            max-width: 600px;
        }

        .result-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .result-stats p {
            margin: 10px 0;
            font-size: 18px;
        }

        .download-btn {
            width: 100%;
            padding: 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        .download-btn:hover {
            background: #1976D2;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin: 15px 0;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Test d'arborescence - Sonification de donn√©es</h1>
            <p>Trouvez les fonctionnalit√©s le plus rapidement possible</p>
        </div>

        <div class="controls">
            <div class="info-bar">
                <div class="info-item">
                    <label>Progression</label>
                    <div class="value" id="progress">0/0</div>
                </div>
                <div class="info-item">
                    <label>Clics</label>
                    <div class="value" id="clicks">0</div>
                </div>
                <div class="info-item">
                    <label>Temps</label>
                    <div class="value" id="timer">0.0s</div>
                </div>
            </div>

            <div id="targetDisplay" class="target-function" style="display: none;">
                Trouvez : <span id="targetName"></span>
            </div>

            <button class="start-btn" id="startBtn">D√©marrer le test</button>
        </div>

        <div class="tree-container" id="treeContainer"></div>
    </div>

    <!-- Modal choix saison -->
<div class="modal active" id="seasonModal">
    <div class="modal-content">
        <h2>Choix de la saison</h2>
        <p>Selectionnez votre saison de naissance : </p>
        <div class="modal-buttons">
            <button class="btn-1" onclick="selectSeason('hiver')">üå®Ô∏è Hiver (1‚Üí2‚Üí4)</button>
            <button class="btn-2" onclick="selectSeason('printemps')">üå∏ Printemps (4‚Üí3‚Üí1)</button>
            <button class="btn-3" onclick="selectSeason('ete')">‚òÄÔ∏è √ât√© (1‚Üí3‚Üí4)</button>
            <button class="btn-4" onclick="selectSeason('automne')">üçÇ Automne (4‚Üí2‚Üí1)</button>
        </div>
    </div>


    <!-- Modal nombre de tests -->
    <div class="modal" id="numTestsModal">
        <div class="modal-content">
            <h2>Nombre de tests</h2>
            <p>Combien de fonctionnalit√©s voulez-vous tester ?</p>
            <input type="number" id="numTestsInput" min="1" value="5">
            <button class="start-btn" onclick="startTests()">Commencer</button>
        </div>
    </div>

    <!-- Modal r√©sultats -->
    <div class="modal results-modal" id="resultsModal">
        <div class="modal-content">
            <h2>üéâ Test termin√© !</h2>
            <div class="result-stats" id="resultStats"></div>
            <button class="download-btn" onclick="downloadResults()">üì• T√©l√©charger les r√©sultats (JSON)</button>
            <button class="start-btn" onclick="location.reload()">Nouveau test</button>
        </div>
    </div>

    <script>
// Donn√©es globales
let selectedTree = null;
let selectedSeason = null;
let currentTreeIndex = 0;
let treesOrder = [];
let allFunctionalities = [];
let currentTest = 0;
let totalTests = 0;
let testStarted = false;
let currentFunctionality = null;
let startTime = null;
let clickCount = 0;
let clickedPath = [];
let results = [];
let timerInterval = null;

// Arborescences (inchang√©)
// Arborescences
        const trees = {
            1: {
                "Null": null,
                "Custom": null,
                "Pass": null,
                "Console Log": null,
                "Arrays": {
                    "Get component": null,
                    "Length": null,
                    "Serve slice": null
                },
                "Channels": {
                    "Mono to all channels": null,
                    "Several to Mono": null,
                    "Two to Stereo": null
                },
                "Conversions": {
                    "Degrees to radian": null,
                    "MIDI to Frequency": null,
                    "Radian to degrees": null,
                    "Str to ASCII": null
                },
                "Envelopes": {
                    "ADSR": null,
                    "Fade In": null,
                    "Fade Out": null
                },
                "Generators": {
                    "Click": null,
                    "Noises": {
                        "Brownian": null,
                        "White": null
                    },
                    "Oscillators": {
                        "CosineWave": null,
                        "Modulate Sine": null,
                        "SawTooth": null,
                        "SineWave": null,
                        "Square": null,
                        "TanWave": null,
                        "Triangle": null
                    }
                },
                "Inputs": {
                    "Files": {
                        "Load Audio": null,
                        "Load CSV": null,
                        "Load Image": null,
                        "Load TXT": null,
                        "Load XLSX": null
                    },
                    "Parameters": {
                        "Number": null,
                        "Range": null,
                        "Text": null
                    },
                    "Sockets": {
                        "HTTP Text": null,
                        "HTTP Audio": null,
                        "TCP": null,
                        "UDP": null
                    }
                },
                "Logic": {
                    "If-then-else": null,
                    "HigherThan": null,
                    "‚â•": null,
                    "LowerThan": null,
                    "‚â§": null,
                    "=": null,
                    "‚â†": null,
                    "and": null,
                    "or": null,
                    "not": null
                },
                "Mappings": {
                    "Linear": null
                },
                "Math": {
                    "Arithmetics": {
                        "+": null,
                        "-": null,
                        "√ó": null,
                        "√∑": null,
                        "Abs": null,
                        "Ceil": null,
                        "Floor": null,
                        "Power": null,
                        "Round": null,
                        "Sign": null,
                        "Sqrt": null
                    },
                    "Trigonometry": {
                        "Acos": null,
                        "Asin": null,
                        "Atan": null,
                        "Atan2": null,
                        "Cos": null,
                        "Sin": null,
                        "Tan": null
                    }
                },
                "Parsers": {
                    "parse Float": null,
                    "parse Int": null,
                    "parse JSON": null,
                    "parse OSC": null
                },
                "Playback": {
                    "Diff ? + retain": null,
                    "Retain Max": null,
                    "Retain Min": null,
                    "Retain Value": null,
                    "Smooth": null,
                    "Speed Multiplier": null
                },
                "Sockets": {
                    "HTTP Text": null,
                    "HTTP Audio": null,
                    "TCP": null,
                    "UDP": null
                }
            },
            2: {
                "1. Sources et Entr√©es": {
                    "G√©n√©rateurs de signaux": {
                        "Click": null,
                        "Noises": {
                            "Brownian": null,
                            "White": null
                        },
                        "Oscillators": {
                            "CosineWave": null,
                            "Modulate Sine": null,
                            "SawTooth": null,
                            "SineWave": null,
                            "Square": null,
                            "TanWave": null,
                            "Triangle": null
                        }
                    },
                    "Entr√©es de donn√©es": {
                        "Files": {
                            "Load Audio": null,
                            "Load CSV": null,
                            "Load Image": null,
                            "Load TXT": null,
                            "Load XLSX": null
                        },
                        "Parameters": {
                            "Number": null,
                            "Range": null,
                            "Text": null
                        },
                        "Sockets": {
                            "HTTP Text": null,
                            "HTTP Audio": null,
                            "TCP": null,
                            "UDP": null
                        }
                    }
                },
                "2. Traitement de Donn√©es": {
                    "Op√©rations Math√©matiques": {
                        "Arithmetics": {
                            "+": null,
                            "-": null,
                            "√ó": null,
                            "√∑": null,
                            "Abs": null,
                            "Ceil": null,
                            "Floor": null,
                            "Round": null,
                            "Sign": null
                        },
                        "Trigonometry": {
                            "Acos": null,
                            "Asin": null,
                            "Atan": null,
                            "Atan2": null,
                            "Cos": null,
                            "Sin": null,
                            "Tan": null
                        }
                    },
                    "Mappages et Conversions": {
                        "Mappings": {
                            "Linear": null
                        },
                        "Conversions": {
                            "Degrees to radian": null,
                            "MIDI to Frequency": null,
                            "Radian to degrees": null,
                            "Str to ASCII": null
                        }
                    }
                },
                "3. Traitement et Routage Audio": {
                    "Forme du signal": {
                        "ADSR": null,
                        "Fade In": null,
                        "Fade Out": null
                    },
                    "Channels": {
                        "Mono to all channels": null,
                        "Several to Mono": null,
                        "Two to Stereo": null
                    },
                    "Contr√¥le de Lecture": {
                        "Playback": {
                            "Diff": null,
                            "Retain Max": null,
                            "Retain Min": null,
                            "Retain Value": null,
                            "Smooth": null,
                            "Speed": null
                        }
                    }
                },
                "4. Logique et Contr√¥le de Flux": {
                    "Op√©rateurs Logiques": {
                        "If-then-else": null,
                        "HigherThan": null,
                        "‚â•": null,
                        "LowerThan": null,
                        "‚â§": null,
                        "=": null,
                        "‚â†": null,
                        "and": null,
                        "or": null,
                        "not": null
                    }
                },
                "5. Utilitaires et Structures de Donn√©es": {
                    "Gestion des Tableaux": {
                        "Arrays": {
                            "Get component": null,
                            "Length": null,
                            "Serve slice": null
                        }
                    },
                    "Analyse": {
                        "Parsers": {
                            "parse Float": null,
                            "parse Int": null,
                            "parse JSON": null,
                            "parse OSC": null
                        }
                    },
                    "G√©n√©ral": {
                        "Null": null,
                        "Custom": null,
                        "Pass": null,
                        "Console Log": null
                    }
                }
            },
            3: {
                "1. G√©n√©ration & Sources de Donn√©es": {
                    "G√©n√©rateurs de Signaux Audio": {
                        "Click": null,
                        "Noises": {
                            "Brownian": null,
                            "White": null
                        },
                        "Oscillators": {
                            "SineWave": null,
                            "Square": null,
                            "SawTooth": null
                        }
                    },
                    "G√©n√©rateurs de Courbes de Contr√¥le": {
                        "Envelopes": {
                            "ADSR": null,
                            "Fade In": null,
                            "Fade Out": null
                        }
                    },
                    "Sources de Donn√©es Externes": {
                        "Files": {
                            "Load Audio": null,
                            "Load CSV": null,
                            "Load TXT": null,
                            "Load XLSX": null,
                            "Load Image": null
                        },
                        "Sockets": {
                            "HTTP Text": null,
                            "HTTP Audio": null,
                            "TCP": null,
                            "UDP": null
                        }
                    },
                    "Entr√©es Utilisateur": {
                        "Parameters": {
                            "Number": null,
                            "Range": null,
                            "Text": null
                        }
                    }
                },
                "2. Transformation & Traitement": {
                    "Traitement Math√©matique & Mapping": {
                        "Arithmetics": {
                            "+": null,
                            "-": null,
                            "√ó": null,
                            "√∑": null,
                            "Abs": null,
                            "Floor": null
                        },
                        "Trigonometry": {
                            "Sin": null,
                            "Cos": null,
                            "Tan": null
                        },
                        "Mappings": {
                            "Linear": null
                        }
                    },
                    "Conversions de Format": {
                        "Degrees to radian": null,
                        "Radian to degrees": null,
                        "MIDI to Frequency": null,
                        "Str to ASCII": null,
                        "Parsers": {
                            "parse JSON": null,
                            "parse OSC": null
                        }
                    },
                    "Traitement du Signal Temporel": {
                        "Playback": {
                            "Smooth": null,
                            "Speed": null,
                            "Diff": null
                        },
                        "Envelopes": {
                            "ADSR": null,
                            "Fade In": null,
                            "Fade Out": null
                        }
                    },
                    "Manipulation de Canaux Audio": {
                        "Channels": {
                            "Mono to all channels": null,
                            "Two to Stereo": null
                        }
                    }
                },
                "3. Contr√¥le & Logique": {
                    "Op√©rateurs Conditionnels": {
                        "If-then-else": null
                    },
                    "Comparateurs": {
                        "HigherThan": null,
                        "‚â•": null,
                        "LowerThan": null,
                        "‚â§": null,
                        "=": null,
                        "‚â†": null
                    },
                    "Op√©rateurs Bool√©ens": {
                        "and": null,
                        "or": null,
                        "not": null
                    }
                },
                "4. Entr√©es & Sorties (I/O)": {
                    "Communication R√©seau": {
                        "Sockets": {
                            "HTTP Text": null,
                            "HTTP Audio": null,
                            "TCP": null,
                            "UDP": null
                        }
                    },
                    "Interaction avec le Syst√®me de Fichiers": {
                        "Files": {
                            "Load Audio": null,
                            "Load CSV": null,
                            "Load Image": null,
                            "Load TXT": null,
                            "Load XLSX": null
                        }
                    },
                    "D√©bogage & Visualisation": {
                        "Console Log": null
                    }
                },
                "5. Analyse & Utilitaires": {
                    "Manipulation de Listes (Arrays)": {
                        "Arrays": {
                            "Get component": null,
                            "Length": null,
                            "Serve slice": null
                        }
                    },
                    "Analyse de Donn√©es (Parsing)": {
                        "Parsers": {
                            "parse Float": null,
                            "parse Int": null,
                            "parse JSON": null,
                            "parse OSC": null
                        }
                    },
                    "Utilitaires de Patching": {
                        "Null": null,
                        "Custom": null,
                        "Pass": null
                    }
                }
            },
            4: {
                "G√©n√©rateur de signaux": {
                    "Sources": {
                        "Brownian": null, "White": null, "Square": null, "SineWave": null,
                        "CosineWave": null, "Triangle": null, "SawTooth": null, "TanWave": null
                    },
                    "G√©n√©ration d'enveloppe": {"ADSR": null, "Fade In": null, "Fade Out": null}
                },
                "Fonctions trigonom√©triques": {
                    "Atan": null, "Cos": null, "Atan2": null, "Asin": null,
                    "Acos": null, "Sin": null, "Tan": null
                },
                "Fonctions math√©matiques": {
                    "Ceil": null, "Floor": null, "Round": null, "Power": null,
                    "Abs": null, "Sign": null, "SQRT": null, "Linear": null
                },
                "Op√©rateurs logiques et math√©matiques": {
                    "=": null, ">=": null, "!=": null, "HigherThan": null,
                    "LowerThan": null, "+": null, "*": null, "-": null,
                    "/": null, "and": null, "not": null, "or": null
                },
                "Programming": {
                    "Pass": null, "Console Log": null, "if-then-else": null, "Custom": null
                },
                "IHM": {"click": null, "Text": null, "Range": null, "Number": null},
                "Input Data": {
                    "Web Search": {"HTTP Text": null, "HTTP Audio": null},
                    "Input Files": {"Load Text": null, "Load CSV": null, "Load XLSX": null, "Load Image": null}
                },
                "Configuration Audio Output": {
                    "Text to Stereo": null, "Mono to all Channels": null, "Several to mono": null
                },
                "Protocole de communication": {"TCP": null, "UDP": null},
                "Signal processing": {"Retain Values": null, "Smooth": null, "Modular Sine": null},
                "Fonctions sur listes": {
                    "Serve Slice": null, "Diff ?+ retain": null, "Length": null,
                    "Retain Min": null, "Retain Max": null, "Get Component": null
                },
                "Conversions": {
                    "Str to ASCII": null, "Radian to Degrees": null, "Degrees to Radian": null,
                    "MID to frequency": null,
                    "Parse": {"Parse Float": null, "Parse Int": null, "Parse JSON": null, "Parse OSC": null}
                }
            }
        };

// D√©finition des ordres de saison
const seasons = {
    hiver: [1, 2, 4],
    printemps: [4, 3, 1],
    ete: [1, 3, 4],
    automne: [4, 2, 1]
};

// Fonction pour s√©lectionner une saison
function selectSeason(season) {
    selectedSeason = season;
    treesOrder = seasons[season];
    document.getElementById('seasonModal').classList.remove('active');
    document.getElementById('numTestsModal').classList.add('active');
}

// Fonction pour d√©marrer les tests
function startTests() {
    totalTests = parseInt(document.getElementById('numTestsInput').value);
    if (totalTests < 1) {
        alert('Nombre invalide !');
        return;
    }
    document.getElementById('numTestsModal').classList.remove('active');
    testStarted = true;
    currentTest = 0;
    results = [];
    currentTreeIndex = 0;
    startNextTreeTests();
}

// Fonction pour d√©marrer les tests de l'arborescence suivante
function startNextTreeTests() {
    if (currentTreeIndex >= treesOrder.length) {
        finishAllTests();
        return;
    }
    selectedTree = treesOrder[currentTreeIndex];
    allFunctionalities = getAllFunctionalities(trees[selectedTree]);
    renderTree(trees[selectedTree]);
    document.getElementById('targetDisplay').style.display = 'none';
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').textContent = `D√©marrer l'arborescence ${selectedTree}`;
    document.getElementById('startBtn').onclick = () => {
        document.getElementById('startBtn').disabled = true;
        nextFunctionality();
    };
}

// Fonction pour passer √† la fonctionnalit√© suivante
function nextFunctionality() {
    if (currentTest >= totalTests) {
        currentTreeIndex++;
        currentTest = 0;
        startNextTreeTests();
        return;
    }
    currentTest++;
    clickCount = 0;
    clickedPath = [];
    currentFunctionality = allFunctionalities[Math.floor(Math.random() * allFunctionalities.length)];
    document.getElementById('targetDisplay').style.display = 'block';
    document.getElementById('targetName').textContent = currentFunctionality.split('/').pop();
    updateDisplay();
    startTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 100);
}

// Fonction pour terminer un test
function endCurrentTest(found) {
    clearInterval(timerInterval);
    const duration = (Date.now() - startTime) / 1000;
    results.push({
        test_number: currentTest,
        tree: selectedTree,
        functionality: currentFunctionality,
        functionality_name: currentFunctionality.split('/').pop(),
        found: found,
        duration_seconds: Math.round(duration * 100) / 100,
        click_count: clickCount,
        path_taken: clickedPath,
        timestamp: new Date().toISOString()
    });
    setTimeout(nextFunctionality, 1000);
}

// Fonction pour terminer tous les tests
function finishAllTests() {
    testStarted = false;
    clearInterval(timerInterval);
    const totalTime = results.reduce((sum, r) => sum + r.duration_seconds, 0);
    const avgTime = totalTime / results.length;
    const totalClicks = results.reduce((sum, r) => sum + r.click_count, 0);
    const avgClicks = totalClicks / results.length;
    document.getElementById('resultStats').innerHTML = `
        <p><strong>Saison :</strong> ${selectedSeason}</p>
        <p><strong>Arborescences test√©es :</strong> ${treesOrder.join(' ‚Üí ')}</p>
        <p><strong>Tests par arborescence :</strong> ${totalTests}</p>
        <p><strong>Temps total :</strong> ${totalTime.toFixed(2)}s</p>
        <p><strong>Temps moyen :</strong> ${avgTime.toFixed(2)}s</p>
        <p><strong>Clics totaux :</strong> ${totalClicks}</p>
        <p><strong>Clics moyens :</strong> ${avgClicks.toFixed(1)}</p>
    `;
    document.getElementById('resultsModal').classList.add('active');
}

// Fonction pour t√©l√©charger les r√©sultats
function downloadResults() {
    const data = {
        session_metadata: {
            season: selectedSeason,
            trees_order: treesOrder,
            tests_per_tree: totalTests,
            total_tests: results.length,
            total_time_seconds: results.reduce((sum, r) => sum + r.duration_seconds, 0),
            average_time_seconds: results.reduce((sum, r) => sum + r.duration_seconds, 0) / results.length,
            total_clicks: results.reduce((sum, r) => sum + r.click_count, 0),
            average_clicks: results.reduce((sum, r) => sum + r.click_count, 0) / results.length,
            session_start: results[0].timestamp,
            session_end: new Date().toISOString()
        },
        results: results
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `test_results_${selectedSeason}_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

// Fonctions utilitaires
function getAllFunctionalities(tree, path = "") {
    let funcs = [];
    for (let [key, value] of Object.entries(tree)) {
        const currentPath = path ? `${path}/${key}` : key;
        if (value === null) {
            funcs.push(currentPath);
        } else {
            funcs = funcs.concat(getAllFunctionalities(value, currentPath));
        }
    }
    return funcs;
}

function renderTree(tree, container = document.getElementById('treeContainer'), path = "") {
    container.innerHTML = '';
    for (let [key, value] of Object.entries(tree)) {
        const currentPath = path ? `${path}/${key}` : key;
        const div = document.createElement('div');
        div.className = 'tree-node';

        const item = document.createElement('div');
        item.className = value === null ? 'tree-item leaf' : 'tree-item parent';
        item.dataset.path = currentPath;

        if (value !== null) {
            const icon = document.createElement('span');
            icon.className = 'toggle-icon';
            icon.textContent = '‚ñ∂';
            item.appendChild(icon);

            const childContainer = document.createElement('div');
            childContainer.style.display = 'none';
            childContainer.className = 'tree-node';

            item.onclick = () => {
                if (testStarted) {
                    clickCount++;
                    updateDisplay();
                    clickedPath.push({type: 'open', path: currentPath, timestamp: Date.now()});
                }

                const isOpen = childContainer.style.display === 'block';
                childContainer.style.display = isOpen ? 'none' : 'block';
                icon.textContent = isOpen ? '‚ñ∂' : '‚ñº';
            };

            renderTree(value, childContainer, currentPath);
            div.appendChild(item);
            div.appendChild(childContainer);
        } else {
            item.onclick = () => handleLeafClick(currentPath, item);
            div.appendChild(item);
        }

        const text = document.createTextNode(key);
        item.appendChild(text);
        container.appendChild(div);
    }
}

function handleLeafClick(path, element) {
    if (!testStarted) return;

    clickCount++;
    updateDisplay();
    clickedPath.push({type: 'click', path: path, timestamp: Date.now()});

    if (path === currentFunctionality) {
        element.classList.add('correct');
        setTimeout(() => endCurrentTest(true), 500);
    } else {
        element.classList.add('wrong');
        setTimeout(() => element.classList.remove('wrong'), 500);
        alert(`Mauvaise fonctionnalit√©!\nVous avez s√©lectionn√© "${path.split('/').pop()}" au lieu de "${currentFunctionality.split('/').pop()}"`);
    }
}

function updateTimer() {
    if (!startTime) return;
    const elapsed = (Date.now() - startTime) / 1000;
    document.getElementById('timer').textContent = elapsed.toFixed(1) + 's';
}

function updateDisplay() {
    document.getElementById('progress').textContent = `${currentTest}/${totalTests}`;
    document.getElementById('clicks').textContent = clickCount;
}
    </script>
</body>
</html>
